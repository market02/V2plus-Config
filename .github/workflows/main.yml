name: Update Configs
permissions: write-all

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 */6 * * *"

concurrency:
  group: update-configs
  cancel-in-progress: false # 新任务排队，不主动取消旧任务

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120 # 120 分钟后强制超时，旧任务会被取消
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.11"

      - name: Install dependencies
        working-directory: Files
        run: pip install -r requirements.txt

      - name: Run Python scripts
        working-directory: Files
        run: |
          python app.py
        #python sort.py

      # 新增：连通性检测和清理无效配置
      - name: Check connectivity and clean invalid configs
        working-directory: Files
        env:
          CONNECT_TIMEOUT: "10"
        run: |
          echo "开始连通性检测..."
          python connectivity_checker.py
          echo "连通性检测完成"

# 新增：IP地理位置分类步骤
      - name: Classify configs by IP geolocation
        working-directory: Files
        run: |
          echo "开始IP地理位置分类..."
          python ip_detector_classifier.py
          echo "IP分类完成"
          echo "分类结果文件:"
          ls -la US_CA_configs.txt EU_JP_KR_configs.txt Other_configs.txt 2>/dev/null || echo "分类文件未生成"

      # 新增：AES加密步骤
      - name: Encrypt valid configs with AES
        working-directory: Files
        run: |
          python encrypt_service.py --password "${{ secrets.AES_PASSWORD }}"
          python encrypt_service.py --password "${{ secrets.AES_PASSWORD }}" --input "./US_CA_configs.txt" --output "../US_CA"
          python encrypt_service.py --password "${{ secrets.AES_PASSWORD }}" --input "./EU_JP_KR_configs.txt" --output "../EU_JP_KR"
          python encrypt_service.py --password "${{ secrets.AES_PASSWORD }}" --input "./Other_configs.txt" --output "../Other"

      - name: Commit and push changes
        uses: EndBug/add-and-commit@v9
        with:
          author_name: "GitHub Actions"
          author_email: "actions@github.com"
          message: "Routine Action Every 6 Hours🤝"
          add: "."
          push: "origin HEAD --force"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 配置多个 SSH 密钥
      - name: Setup SSH Agent for multiple keys
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.GITCODE_SSH_PRIVATE_KEY }}
            ${{ secrets.GITEE_SSH_PRIVATE_KEY }}

      - name: Add Git hosts to known hosts
        run: |
          ssh-keyscan -H gitcode.com >> ~/.ssh/known_hosts
          ssh-keyscan -H gitee.com >> ~/.ssh/known_hosts

      # 添加 SSH 调试步骤
      - name: Debug SSH connections
        run: |
          echo "Testing SSH connection to gitcode.com..."
          ssh -T git@gitcode.com -o StrictHostKeyChecking=no || echo "GitCode SSH test completed with exit code $?"
          echo "Testing SSH connection to gitee.com..."
          ssh -T git@gitee.com -o StrictHostKeyChecking=no || echo "Gitee SSH test completed with exit code $?"
          echo "Listing SSH keys:"
          ssh-add -l

      - name: Configure Git and Deploy to Remote Repositories
        run: |
          # 配置 Git 全局设置
          git config --global user.name "amessboy"
          git config --global user.email "v9736982301@outlook.com"
          git config --global init.defaultBranch main

          # 部署到 GitCode
          git clone git@gitcode.com:amessboy/DeployData.git gitcode-deploy
          cd gitcode-deploy
          # 复制加密的主文件并重命名为result
          cp ../All_Configs_Sub_valid.txt.encrypted ./result
          cp ../All_Configs_Sub_valid.txt ./result2
          # 复制加密后的三个配置文件
          cp ../US_CA ./US_CA 2>/dev/null || echo "US_CA not found"
          cp ../EU_JP_KR ./EU_JP_KR 2>/dev/null || echo "EU_JP_KR not found"
          cp ../Other ./Other 2>/dev/null || echo "Other not found"
          git add .
          git commit -m "Update encrypted configs from GitHub Actions" || echo "No changes to commit"
          git pull --strategy-option=theirs && git push  # 优先使用远程版本
          cd ..

          # 部署到 Gitee
          git clone git@gitee.com:amessboy/DeployData.git gitee-deploy
          cd gitee-deploy
          # 复制加密的主文件并重命名为result
          cp ../All_Configs_Sub_valid.txt.encrypted ./result
          cp ../All_Configs_Sub_valid.txt ./result2
          # 复制加密后的三个配置文件
          cp ../US_CA ./US_CA 2>/dev/null || echo "US_CA not found"
          cp ../EU_JP_KR ./EU_JP_KR 2>/dev/null || echo "EU_JP_KR not found"
          cp ../Other ./Other 2>/dev/null || echo "Other not found"
          git add .
          git commit -m "Update encrypted configs from GitHub Actions" || echo "No changes to commit"
          git pull --strategy-option=theirs && git push  # 优先使用远程版本
          cd ..
