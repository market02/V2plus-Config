name: Update Configs
permissions: write-all

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 */2 * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code  
      uses: actions/checkout@v2  
      with:
        fetch-depth: 0  
        persist-credentials: true  

    - name: Set up Python  
      uses: actions/setup-python@v2  
      with:
        python-version: '3.11'

    - name: Install dependencies  
      working-directory: Files  
      run: pip install -r requirements.txt

    - name: Run Python scripts  
      working-directory: Files  
      run: |
        python app.py
      #python sort.py

    # Êñ∞Â¢ûÔºöËøûÈÄöÊÄßÊ£ÄÊµãÂíåÊ∏ÖÁêÜÊó†ÊïàÈÖçÁΩÆ
    - name: Check connectivity and clean invalid configs
      working-directory: Files
      run: |
        echo "ÂºÄÂßãËøûÈÄöÊÄßÊ£ÄÊµã..."
        python connectivity_checker.py
        echo "ËøûÈÄöÊÄßÊ£ÄÊµãÂÆåÊàê"

    - name: Commit and push changes
      uses: EndBug/add-and-commit@v7
      with:
        author_name: "GitHub Actions"
        author_email: "actions@github.com"
        message: "Updated 6 Hours Agoü§ù"
        add: "."
        pull: "NO-PULL"
        push: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


    # ÈÖçÁΩÆÂ§ö‰∏™ SSH ÂØÜÈí•
    - name: Setup SSH Agent for multiple keys
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: |
          ${{ secrets.GITCODE_SSH_PRIVATE_KEY }}
          ${{ secrets.GITEE_SSH_PRIVATE_KEY }}

    - name: Add Git hosts to known hosts
      run: |
        ssh-keyscan -H gitcode.com >> ~/.ssh/known_hosts
        ssh-keyscan -H gitee.com >> ~/.ssh/known_hosts

    # Ê∑ªÂä† SSH Ë∞ÉËØïÊ≠•È™§
    - name: Debug SSH connections
      run: |
        echo "Testing SSH connection to gitcode.com..."
        ssh -T git@gitcode.com -o StrictHostKeyChecking=no || echo "GitCode SSH test completed with exit code $?"
        echo "Testing SSH connection to gitee.com..."
        ssh -T git@gitee.com -o StrictHostKeyChecking=no || echo "Gitee SSH test completed with exit code $?"
        echo "Listing SSH keys:"
        ssh-add -l

    - name: Configure Git and Deploy to Remote Repositories
      run: |
        # ÈÖçÁΩÆ Git ÂÖ®Â±ÄËÆæÁΩÆ
        git config --global user.name "amessboy"
        git config --global user.email "v9736982301@outlook.com"
        git config --global init.defaultBranch main

        # ÈÉ®ÁΩ≤Âà∞ GitCode
        git clone git@gitcode.com:amessboy/DeployData.git gitcode-deploy
        cd gitcode-deploy
        cp ../All_Configs_Sub_valid_base64.txt ./
        git add .
        git commit -m "Update valid configs from GitHub Actions" || echo "No changes to commit"
        git pull && git push
        cd ..
        
        # ÈÉ®ÁΩ≤Âà∞ Gitee
        git clone git@gitee.com:amessboy/DeployData.git gitee-deploy
        cd gitee-deploy
        cp ../All_Configs_Sub_valid_base64.txt ./
        git add .
        git commit -m "Update valid configs from GitHub Actions" || echo "No changes to commit"
        git pull && git push
        cd ..

