name: Update Configs
permissions: write-all

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 */6 * * *"

concurrency:
  group: update-configs
  cancel-in-progress: false # æ–°ä»»åŠ¡æŽ’é˜Ÿï¼Œä¸ä¸»åŠ¨å–æ¶ˆæ—§ä»»åŠ¡

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120 # 120 åˆ†é’ŸåŽå¼ºåˆ¶è¶…æ—¶
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Python scripts
        working-directory: src
        run: |
          python app.py
          # python sort.py

      # è¿žé€šæ€§æ£€æµ‹å’Œæ¸…ç†æ— æ•ˆé…ç½®
      - name: Check connectivity and clean invalid configs
        working-directory: src
        env:
          CONNECT_TIMEOUT: "10"
        run: |
          echo "å¼€å§‹è¿žé€šæ€§æ£€æµ‹..."
          python connectivity_checker.py
          echo "è¿žé€šæ€§æ£€æµ‹å®Œæˆ"

      # åŠ å¯†ï¼šä¸»æ–‡ä»¶å¿…åšï¼ŒåŒºåŸŸæ–‡ä»¶å­˜åœ¨æ‰åš
      - name: Encrypt valid configs with AES
        working-directory: src
        env:
          ENCRYPT_PASSWORD: ${{ secrets.AES_PASSWORD }}
        run: |
          # ä¸»æ–‡ä»¶åŠ å¯†ï¼ˆå§‹ç»ˆå­˜åœ¨ï¼‰
          python encrypt_service.py --password "${{ secrets.AES_PASSWORD }}"

          # åŒºåŸŸæ–‡ä»¶ï¼šå­˜åœ¨æ‰åŠ å¯†
          [[ -f ../data/US_CA.txt ]] && python encrypt_service.py \
            --password "${{ secrets.AES_PASSWORD }}" \
            --input "../data/US_CA.txt" --output "../data/US_CA" || true

          [[ -f ../data/EU_JP_KR.txt ]] && python encrypt_service.py \
            --password "${{ secrets.AES_PASSWORD }}" \
            --input "../data/EU_JP_KR.txt" --output "../data/EU_JP_KR" || true

          [[ -f ../data/Other.txt ]] && python encrypt_service.py \
            --password "${{ secrets.AES_PASSWORD }}" \
            --input "../data/Other.txt" --output "../data/Other" || true

          # éªŒè¯result*æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          echo "æ£€æŸ¥ç”Ÿæˆçš„resultæ–‡ä»¶ï¼š"
          ls -la ../data/result* || echo "æœªæ‰¾åˆ°resultæ–‡ä»¶"

      - name: Commit and push changes
        uses: EndBug/add-and-commit@v9
        with:
          author_name: "GitHub Actions"
          author_email: "actions@github.com"
          message: "Routine Action Every 6 HoursðŸ¤"
          add: "."
          push: "origin HEAD --force"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # å¤šå¯†é’¥ SSH é…ç½®
      - name: Setup SSH Agent for multiple keys
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.GITCODE_SSH_PRIVATE_KEY }}
            ${{ secrets.GITEE_SSH_PRIVATE_KEY }}
            ${{ secrets.ATOMGIT_SSH_PRIVATE_KEY }}

      - name: Add Git hosts to known hosts
        run: |
          ssh-keyscan -H gitcode.com >> ~/.ssh/known_hosts || echo "Failed to add gitcode.com to known_hosts"
          ssh-keyscan -H gitee.com >> ~/.ssh/known_hosts || echo "Failed to add gitee.com to known_hosts"
          ssh-keyscan -H atomgit.com >> ~/.ssh/known_hosts || echo "Failed to add atomgit.com to known_hosts"

      - name: Debug SSH connections
        run: |
          echo "Testing SSH connection to gitcode.com..."
          ssh -T git@gitcode.com -o StrictHostKeyChecking=no || echo "GitCode SSH test completed with exit code $?"
          echo "Testing SSH connection to gitee.com..."
          ssh -T git@gitee.com -o StrictHostKeyChecking=no || echo "Gitee SSH test completed with exit code $?"
          echo "Testing SSH connection to atomgit.com..."
          ssh -T git@atomgit.com -o StrictHostKeyChecking=no || echo "AtomGit SSH test completed with exit code $?"
          echo "Listing SSH keys:"
          ssh-add -l

      # éƒ¨ç½²åˆ° GitCode & Gitee
      - name: Configure Git and Deploy to Remote Repositories
        run: |
          git config --global user.name "amessboy"
          git config --global user.email "v9736982301@outlook.com"
          git config --global init.defaultBranch main

          # ---------- GitCode ----------
          echo "Starting GitCode deployment..."
          if git clone git@gitcode.com:amessboy/DeployData.git gitcode-deploy; then
            cd gitcode-deploy
            rm -f result[0-9]* || true
            cp ../data/All_Configs_Sub_valid.txt ./m_result
            for f in ../data/result*; do
              if [ -f "$f" ]; then
                base=$(basename "$f")
                cp "$f" "./$base"
              fi
            done
            [[ -f ../data/US_CA ]] && cp ../data/US_CA ./US_CA || true
            [[ -f ../data/EU_JP_KR ]] && cp ../data/EU_JP_KR ./EU_JP_KR || true
            [[ -f ../data/Other ]] && cp ../data/Other ./Other || true
            git add -A .
            git commit -m "Update encrypted configs from GitHub Actions" || echo "No changes to commit"
            git pull --strategy-option=theirs && git push || echo "GitCode push failed"
            cd ..
            echo "GitCode deployment completed"
          else
            echo "GitCode clone failed, skipping GitCode deployment"
          fi

          # ---------- Gitee ----------
          echo "Starting Gitee deployment..."
          if git clone git@gitee.com:amessboy/DeployData.git gitee-deploy; then
            cd gitee-deploy
            rm -f result[0-9]* || true
            cp ../data/All_Configs_Sub_valid.txt ./m_result
            for f in ../data/result*; do
              if [ -f "$f" ]; then
                base=$(basename "$f")
                cp "$f" "./$base"
              fi
            done
            [[ -f ../data/US_CA ]] && cp ../data/US_CA ./US_CA || true
            [[ -f ../data/EU_JP_KR ]] && cp ../data/EU_JP_KR ./EU_JP_KR || true
            [[ -f ../data/Other ]] && cp ../data/Other ./Other || true
            git add -A .
            git commit -m "Update encrypted configs from GitHub Actions" || echo "No changes to commit"
            git pull --strategy-option=theirs && git push || echo "Gitee push failed"
            cd ..
            echo "Gitee deployment completed"
          else
            echo "Gitee clone failed, skipping Gitee deployment"
          fi

          # ---------- AtomGit ----------
          echo "Starting AtomGit deployment..."
          if git clone git@atomgit.com:amessboy/DeployData.git atomgit-deploy; then
            cd atomgit-deploy
            rm -f result[0-9]* || true
            cp ../data/All_Configs_Sub_valid.txt ./m_result
            for f in ../data/result*; do
              if [ -f "$f" ]; then
                base=$(basename "$f")
                cp "$f" "./$base"
              fi
            done
            [[ -f ../data/US_CA ]] && cp ../data/US_CA ./US_CA || true
            [[ -f ../data/EU_JP_KR ]] && cp ../data/EU_JP_KR ./EU_JP_KR || true
            [[ -f ../data/Other ]] && cp ../data/Other ./Other || true
            git add -A .
            git commit -m "Update encrypted configs from GitHub Actions" || echo "No changes to commit"
            git pull --strategy-option=theirs && git push || echo "AtomGit push failed"
            cd ..
            echo "AtomGit deployment completed"
          else
            echo "AtomGit clone failed, skipping AtomGit deployment"
          fi
