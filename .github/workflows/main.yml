name: Update Configs
permissions: write-all

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 */2 * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code  
      uses: actions/checkout@v2  
      with:
        fetch-depth: 0  
        persist-credentials: true  

    - name: Set up Python  
      uses: actions/setup-python@v2  
      with:
        python-version: '3.11'

    - name: Install dependencies  
      working-directory: Files  
      run: pip install -r requirements.txt

    - name: Run Python scripts  
      working-directory: Files  
      run: |
        python app.py
      #python sort.py

    # æ–°å¢ï¼šè¿é€šæ€§æ£€æµ‹å’Œæ¸…ç†æ— æ•ˆé…ç½®
    - name: Check connectivity and clean invalid configs
      working-directory: Files
      run: |
        echo "å¼€å§‹è¿é€šæ€§æ£€æµ‹..."
        python connectivity_checker.py
        echo "è¿é€šæ€§æ£€æµ‹å®Œæˆ"

    # æ–°å¢ï¼šAESåŠ å¯†æ­¥éª¤
    - name: Encrypt valid configs with AES
      working-directory: Files
      run: |
        echo "å¼€å§‹AESåŠ å¯†..."
        python -c "
        from encrypt_service import EncryptService
        import os
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if os.path.exists('../All_Configs_Sub_valid.txt'):
            encrypt_service = EncryptService('v2plus')
            encrypted_file = encrypt_service.encrypt_file('../All_Configs_Sub_valid.txt', '../All_Configs_Sub_valid.txt.encrypted')
            print(f'æ–‡ä»¶å·²åŠ å¯†: {encrypted_file}')
        else:
            print('æœªæ‰¾åˆ°æœ‰æ•ˆé…ç½®æ–‡ä»¶ï¼Œè·³è¿‡åŠ å¯†æ­¥éª¤')
        "
        echo "AESåŠ å¯†å®Œæˆ"

    - name: Commit and push changes
      uses: EndBug/add-and-commit@v7
      with:
        author_name: "GitHub Actions"
        author_email: "actions@github.com"
        message: "Updated 6 Hours AgoğŸ¤"
        add: "."
        pull: "NO-PULL"
        push: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


    # é…ç½®å¤šä¸ª SSH å¯†é’¥
    - name: Setup SSH Agent for multiple keys
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: |
          ${{ secrets.GITCODE_SSH_PRIVATE_KEY }}
          ${{ secrets.GITEE_SSH_PRIVATE_KEY }}

    - name: Add Git hosts to known hosts
      run: |
        ssh-keyscan -H gitcode.com >> ~/.ssh/known_hosts
        ssh-keyscan -H gitee.com >> ~/.ssh/known_hosts

    # æ·»åŠ  SSH è°ƒè¯•æ­¥éª¤
    - name: Debug SSH connections
      run: |
        echo "Testing SSH connection to gitcode.com..."
        ssh -T git@gitcode.com -o StrictHostKeyChecking=no || echo "GitCode SSH test completed with exit code $?"
        echo "Testing SSH connection to gitee.com..."
        ssh -T git@gitee.com -o StrictHostKeyChecking=no || echo "Gitee SSH test completed with exit code $?"
        echo "Listing SSH keys:"
        ssh-add -l

    - name: Configure Git and Deploy to Remote Repositories
      run: |
        # é…ç½® Git å…¨å±€è®¾ç½®
        git config --global user.name "amessboy"
        git config --global user.email "v9736982301@outlook.com"
        git config --global init.defaultBranch main

        # éƒ¨ç½²åˆ° GitCode
        git clone git@gitcode.com:amessboy/DeployData.git gitcode-deploy
        cd gitcode-deploy
        # å¤åˆ¶æ–‡ä»¶å¹¶é‡å‘½åä¸ºresult
        cp ../All_Configs_Sub_valid.txt.encrypted ./result
        git add .
        git commit -m "Update encrypted configs from GitHub Actions" || echo "No changes to commit"
        git pull && git push
        cd ..
        
        # éƒ¨ç½²åˆ° Gitee
        git clone git@gitee.com:amessboy/DeployData.git gitee-deploy
        cd gitee-deploy
        # å¤åˆ¶æ–‡ä»¶å¹¶é‡å‘½åä¸ºresult
        cp ../All_Configs_Sub_valid.txt.encrypted ./result
        git add .
        git commit -m "Update encrypted configs from GitHub Actions" || echo "No changes to commit"
        git pull && git push
        cd ..

